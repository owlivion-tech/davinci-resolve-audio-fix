name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    name: Create Signed Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------------------------
      # Build .deb package
      # -------------------------------------------------------------------
      - name: Install dpkg tools
        run: sudo apt-get install -y dpkg-dev

      - name: Build .deb package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          chmod +x packaging/build_deb.sh
          bash packaging/build_deb.sh "$VERSION"
          echo "DEB_FILE=davinci-resolve-audio-fix_${VERSION}_all.deb" >> "$GITHUB_ENV"

      # -------------------------------------------------------------------
      # Generate SHA256 checksums for all release assets
      # -------------------------------------------------------------------
      - name: Generate checksums
        run: |
          sha256sum \
            install.sh \
            uninstall.sh \
            verify.sh \
            "$DEB_FILE" \
            > checksums.sha256

          echo ""
          echo "=== checksums.sha256 ==="
          cat checksums.sha256

      # -------------------------------------------------------------------
      # GPG-sign the checksums file
      # -------------------------------------------------------------------
      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | \
            gpg --batch --import

      - name: Sign checksums
        run: |
          gpg --batch --yes \
            --detach-sign --armor \
            --output checksums.sha256.sig \
            checksums.sha256

      # -------------------------------------------------------------------
      # Create GitHub Release
      # -------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            checksums.sha256
            checksums.sha256.sig
            install.sh
            uninstall.sh
            verify.sh
            ${{ env.DEB_FILE }}
